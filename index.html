<html>
  <head>
    <title>Community Lands Monitoring Station</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script>
    const ipc = require('ipc');
    const shell = require('shell');
    var config = null;
    var updateOnlineStatus = function() {
      ipc.send('community_lands_online', navigator.onLine);
    };
    ipc.on('backup_submissions_complete', function(result) {
      document.getElementById("backup_status").innerHTML = "";
      var json = JSON.parse(result);
      if (json.error) {
        alert(json.message);
      } else {
        document.getElementById('backup_status').innerHTML = 'Backup of ' + json.file + 
          ' complete.<br/>Open: <a id="backup_file" href="javascript:openBackupFile();" ' + 
          'data-location="' + json.location + '">' + json.location + '</a>';
        ipc.send('check_last_backup');
      }
    });
    ipc.on('has_last_backup', function(result) {
      var json = JSON.parse(result);
      if (json.date)
        document.getElementById('last_backup').innerHTML = '<p>Last Backup: <a href="javascript:openBackupFolder();">' + new Date(json.date) + '</a></p>';
    });
    ipc.on('has_select_form', function(result) {
      ipc.send('form_list');
    });
    ipc.on('has_form_delete', function(result) {
      ipc.send('form_list');
    });
    ipc.on('has_form_list', function(result) {
      var forms = result.forms;
      if (forms.length > 0) {
        var content = '<h5>My Monitoring Forms</h5><table class="table table-condensed">';
        for (var index in forms) {
          content += '<tr>' + 
            '<td>' + forms[index] + '</td>' + 
            '<td align="right"><div data-form="' + forms[index] + '" class="delete-form btn btn-small"><i class="glyphicon glyphicon-remove"/></div></td>' +
            '</tr>';
        }
        content += "</table>";
        document.getElementById('form_listing').innerHTML = content;
        var els = document.getElementsByClassName('delete-form');
        for (var index in els) {
          els[index].onclick = function() {
            var form = this.getAttribute('data-form');
            if (confirm("Are you sure you want to delete the form " + form + "?")) {
              ipc.send('form_delete', form);
            }
          }
        }
      } else {
        document.getElementById('form_listing').innerHTML = "";
      }
    });
    ipc.on('has_filter_list', function(result) {
      document.getElementById('saved-filters').innerHTML = "";
      var json = JSON.parse(result);
      if (!json.error) {
        var filters = json.filters;
        if (filters.length > 0) {
          var content = '<h5>Saved Filters</h5><ul>';
          for (var index in filters) {
            content += '<li><a class="map-link" href="' + config.baseUrl + '/mapfilter?filter=' + filters[index].id + '">' +
              filters[index].name + '</a></li>';
          }
          content += "</ul>"
          document.getElementById('saved-filters').innerHTML = content;
          var els = document.getElementsByClassName('map-link');
          for (var i in els) {
            els[i].onclick = function(event) {
              event.preventDefault();
              shell.openExternal(this.getAttribute('href'));
            };
          }
        }
      }
    });
    ipc.on('has_community_lands_online', function(status) {
      if (status == true || status == 'true')
        ipc.send('community_lands_status');
      else {
        document.getElementById('connection_status').innerHTML = "Offline";
        document.getElementById('community_lands_sync_date').innerHTML = "Unavailable";
      }
    });
    ipc.on('has_community_lands_status', function(result) {
      document.getElementById('connection_status').innerHTML = "Online";
      if (result != null && result != "") {
        var json = JSON.parse(result);
        if (json.date)
          document.getElementById('community_lands_sync_date').innerHTML = new Date(json.date);
        else
          document.getElementById('community_lands_sync_date').innerHTML = "Unavailable";
      } else
        document.getElementById('community_lands_sync_date').innerHTML = "Unavailable";
    });
    ipc.on('has_community_lands_backup', function(result) {
      var json = JSON.parse(result);
      var html = "";
      html += "Upload ";
      if (json.error) {
        html += "Failed.";
        if (json.message)
          html += " " + json.message;
      }
      else {
        html += "Succeeded. ";
        html += "Files Uploaded: ";
        html += json.entity.files_uploaded;
      }
      document.getElementById('community_lands_sync_status').innerHTML = html;
      ipc.send('community_lands_status');
    });
    ipc.on('has_configuration', function(configuration) {
      config = configuration;
      document.getElementById('baseUrl').innerHTML = configuration.baseUrl
      document.getElementById('shared_secret').innerHTML = configuration.shared_secret
      document.getElementById('mapUrl').innerHTML = configuration.baseUrl + "/mapfilter"
      document.getElementById('form_folder').innerHTML = configuration.directory + "/Monitoring/" + configuration.station + "/Forms"
      if (configuration.community_lands == true)
        document.getElementById('community_lands_content').className = "";
    });
    ipc.send('show_configuration');
    ipc.send('check_last_backup');
    ipc.send('form_list');
    ipc.send('filter_list');

    window.addEventListener('online',  updateOnlineStatus);
    window.addEventListener('offline',  updateOnlineStatus);

    updateOnlineStatus();

    function communityLandsUpload() {
      if (navigator.onLine) {
        document.getElementById('community_lands_sync_status').innerHTML = "Uploading, please wait...";
        ipc.send('community_lands_backup');
      } else {
        alert("No internet connection detected");
      }
    }

    function backupFiles() {
      document.getElementById('backup_status').innerHTML = "Saving files, please wait...";
      ipc.send('backup_submissions');
    }

    function openBackupFile() {
      var file = document.getElementById('backup_file').getAttribute('data-location');
      shell.showItemInFolder(file);
    }

    function openBackupFolder() {
      if (config)
        shell.showItemInFolder(config.directory + "/Monitoring/" + config.station + "/Backup");
    }

    function selectForm() {
      ipc.send('select_form');
    }

    </script>
  </head>
  <body><div class="container-fluid"><div class="row"><div class="col-xs-12">
    <div class="alert alert-info" style='margin-top: 10px'><b>The monitoring station will run as long as this window is open.</b></div>
    <h4>ODK Collect settings</h4>
    <div class="well">
      <div>
        Base URL:
      </div>
      <div><b id="baseUrl"></b></div>
      <div>
        Use your agent number as the username.
      </div>
      <div>
        Password:
      </div>
      <div><b id="shared_secret"></b></div>
    </div>
    <h4>Browser settings</h4>
    <div class="well">
      <div>
        URL for viewing maps in your browser:
      </div>
      <div><b id="mapUrl"></b></div>
      <div id="saved-filters">
      </div>
    </div>
    <h4>Monitoring Forms</h4>
    <div class="well">
      <div>
        Folder for blank monitoring forms:
      </div>
      <div><b id="form_folder"></b></div>
      <div id="form_listing">
      </div>
      <h5>Add New Form</h5>
      <button onclick="javascript:selectForm();" class="btn btn-small btn-primary">Select from File</button>
    </div>
    <h4>Data Backup</h4>
    <div class="well">
      <div id="last_backup"></div>
      <div class="btn btn-small btn-primary" style="margin-top: 10px" onclick="javascript:backupFiles()">Backup Data</div>
      <div style="margin-top: 10px" id="backup_status"></div>
    </div>
    <div class="hidden" id="community_lands_content">
      <h4>Community Lands</h4>
      <div class="well">
        <div>
          <span>Connection Status: </span>
          <span id="connection_status" style="font-weight: bold">Pending</span>
        </div>
        <div>
          <span>Last Synchronized: </span>
          <span id="community_lands_sync_date" style="font-weight: bold">Unavailable</span>
        </div>
        <div class="btn btn-small btn-primary" style="margin-top: 10px" onclick="javascript:communityLandsUpload()">Upload</div>
        <div style="margin-top: 10px" id="community_lands_sync_status"></div>
      </div>
    </div>
  </div></div></div></body>
</html>
