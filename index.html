<html>
  <head>
    <title>Community Lands Monitoring Station</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script>
    var ipc = require('ipc');
    var updateOnlineStatus = function() {
      ipc.send('community_lands_online', navigator.onLine);
    };
    ipc.on('has_community_lands_online', function(status) {
      if (status == true || status == 'true')
        ipc.send('community_lands_status');
      else {
        document.getElementById('connection_status').innerHTML = "Offline";
        document.getElementById('community_lands_sync_date').innerHTML = "Unavailable";
      }
    });
    ipc.on('has_community_lands_status', function(result) {
      document.getElementById('connection_status').innerHTML = "Online";
      if (result != null && result != "") {
        var json = JSON.parse(result);
        if (json.date)
          document.getElementById('community_lands_sync_date').innerHTML = new Date(json.date);
        else
          document.getElementById('community_lands_sync_date').innerHTML = "Unavailable";
      } else
        document.getElementById('community_lands_sync_date').innerHTML = "Unavailable";
    });
    ipc.on('has_community_lands_backup', function(result) {
      var json = JSON.parse(result);
      var html = "";
      html += "Upload ";
      if (json.error) {
        html += "Failed.";
        if (json.message)
          html += " " + json.message;
      }
      else {
        html += "Succeeded. ";
        html += "Files Uploaded: ";
        html += json.entity.files_uploaded;
      }
      document.getElementById('community_lands_sync_status').innerHTML = html;
      ipc.send('community_lands_status');
    });
    ipc.on('has_configuration', function(configuration) {
      document.getElementById('baseUrl').innerHTML = configuration.baseUrl
      document.getElementById('shared_secret').innerHTML = configuration.shared_secret
      document.getElementById('mapUrl').innerHTML = configuration.baseUrl + "/mapfilter"
      document.getElementById('form_folder').innerHTML = configuration.directory + "/Monitoring/" + configuration.station + "/Forms"
      if (configuration.community_lands == true)
        document.getElementById('community_lands_content').className = "";
    });
    ipc.send('show_configuration');

    window.addEventListener('online',  updateOnlineStatus);
    window.addEventListener('offline',  updateOnlineStatus);

    updateOnlineStatus();

    function communityLandsUpload() {
      if (navigator.onLine) {
        document.getElementById('community_lands_sync_status').innerHTML = "Uploading, please wait...";
        ipc.send('community_lands_backup');
      } else {
        alert("No internet connection detected");
      }
    }
    </script>
  </head>
  <body><div class="container-fluid"><div class="row"><div class="col-xs-12">
    <div class="alert alert-info" style='margin-top: 10px'><b>The monitoring station will run as long as this window is open.</b></div>
    <h4>ODK Collect settings</h4>
    <div class="well">
      <div>
        Base URL:
      </div>
      <div><b id="baseUrl"></b></div>
      <div>
        Use your agent number as the username.
      </div>
      <div>
        Password:
      </div>
      <div><b id="shared_secret"></b></div>
    </div>
    <h4>Browser settings</h4>
    <div class="well">
      <div>
        URL for viewing maps in your browser:
      </div>
      <div><b id="mapUrl"></b></div>
    </div>
    <h4>Advanced</h4>
    <div class="well">
      <div>
        Folder for blank monitoring forms:
      </div>
      <div><b id="form_folder"></b></div>
      <div class="btn btn-small btn-primary" style="margin-top: 10px">Backup Data</div>
    </div>
    <div class="hidden" id="community_lands_content">
      <h4>Community Lands</h4>
      <div class="well">
        <div>
          <span>Connection Status: </span>
          <span id="connection_status" style="font-weight: bold">Pending</span>
        </div>
        <div>
          <span>Last Synchronized: </span>
          <span id="community_lands_sync_date" style="font-weight: bold">Unavailable</span>
        </div>
        <div class="btn btn-small btn-primary" style="margin-top: 10px" onclick="javascript:communityLandsUpload()">Upload</div>
        <div style="margin-top: 10px" id="community_lands_sync_status"></div>
      </div>
    </div>
  </div></div></div></body>
</html>
