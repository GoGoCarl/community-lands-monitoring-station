<html>
  <head>
    <title>Community Lands Monitoring Station</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="application/locale.js"></script>
    <script>
    window.locale.en = require('./application/data/en')
    window.locale.es = require('./application/data/es')
    window.locale.init();

    const ipc = require('ipc');
    const shell = require('shell');
    var config = null;
    var updateOnlineStatus = function() {
      ipc.send('community_lands_online', navigator.onLine);
    };
    ipc.on('backup_submissions_complete', function(result) {
      document.getElementById("backup_status").innerHTML = "";
      var json = JSON.parse(result);
      if (json.error) {
        alert(t('error.'+json.code));
      } else {
        document.getElementById('backup_status').innerHTML = t('text.backup_complete') + 
          '<br/>' + t('prompt.open') + '<a id="backup_file" href="javascript:openBackupFile();" ' + 
          'data-location="' + json.location + '">' + json.location + '</a>';
        ipc.send('check_last_backup');
      }
    });
    ipc.on('has_last_backup', function(result) {
      var json = JSON.parse(result);
      if (json.date)
        document.getElementById('last_backup').innerHTML = '<p>' + 
          t('prompt.last_backup') + '<a href="javascript:openBackupFolder();">' + new Date(json.date) + '</a></p>';
    });
    ipc.on('has_select_form', function(result) {
      ipc.send('form_list');
    });
    ipc.on('has_form_delete', function(result) {
      ipc.send('form_list');
    });
    ipc.on('has_form_list', function(result) {
      var forms = result.forms;
      if (forms.length > 0) {
        var content = '<h5>' + t('title.my_monitoring_forms') + '</h5><table class="table table-condensed">';
        for (var index in forms) {
          content += '<tr>' + 
            '<td>' + forms[index] + '</td>' + 
            '<td align="right"><div data-form="' + forms[index] + '" class="delete-form btn btn-small"><i class="glyphicon glyphicon-remove"/></div></td>' +
            '</tr>';
        }
        content += "</table>";
        document.getElementById('form_listing').innerHTML = content;
        var els = document.getElementsByClassName('delete-form');
        for (var index in els) {
          els[index].onclick = function() {
            var form = this.getAttribute('data-form');
            if (confirm(t('confirm.delete_form'))) {
              ipc.send('form_delete', form);
            }
          }
        }
      } else {
        document.getElementById('form_listing').innerHTML = "";
      }
    });
    ipc.on('has_filter_list', function(result) {
      document.getElementById('saved-filters').innerHTML = "";
      var json = JSON.parse(result);
      if (!json.error) {
        var filters = json.filters;
        if (filters.length > 0) {
          var content = '<h5>' + t('title.saved_filters') + '</h5><ul>';
          for (var index in filters) {
            content += '<li><a class="map-link" href="' + config.baseUrl + '/mapfilter?locale=' + config.locale + '&filter=' + filters[index].id + '">' +
              filters[index].name + '</a></li>';
          }
          content += "</ul>"
          document.getElementById('saved-filters').innerHTML = content;
          var els = document.getElementsByClassName('map-link');
          for (var i in els) {
            els[i].onclick = function(event) {
              event.preventDefault();
              shell.openExternal(this.getAttribute('href'));
            };
          }
        }
      }
    });
    ipc.on('has_community_lands_online', function(status) {
      if (status == true || status == 'true')
        ipc.send('community_lands_status');
      else {
        document.getElementById('connection_status').innerHTML = t('text.offline');
        document.getElementById('community_lands_sync_date').innerHTML = t('text.unavailable');
      }
    });
    ipc.on('has_community_lands_status', function(result) {
      document.getElementById('connection_status').innerHTML = t('text.online');
      if (result != null && result != "") {
        var json = JSON.parse(result);
        if (json.date)
          document.getElementById('community_lands_sync_date').innerHTML = new Date(json.date);
        else
          document.getElementById('community_lands_sync_date').innerHTML = t('text.unavailable');
      } else
        document.getElementById('community_lands_sync_date').innerHTML = t('text.unavailable');
    });
    ipc.on('has_community_lands_backup', function(result) {
      var json = JSON.parse(result);
      var html = "";
      if (json.error) {
        html += t('text.upload_failed');
        if (json.code)
          html += " " + t('error.' + json.code);
        else if (json.message)
          html += " " + json.message;
      }
      else {
        html += t('text.upload_success');
        html += " ";
        html += t('text.files_uploaded');
        html += " ";
        html += json.entity.files_uploaded;
      }
      document.getElementById('community_lands_sync_status').innerHTML = html;
      ipc.send('community_lands_status');
    });
    ipc.on('has_settings_list', function(settings) {
      var sections = {
        general: '',
        mapfilter: '',
        communitylands: '',
        advanced: ''
      };
      var section_keys = {
        mapZoom: 'mapfilter',
        mapCenterLat: 'mapfilter',
        mapCenterLong: 'mapfilter',
        community_lands_token: 'communitylands',
        community_lands_server: 'advanced',
        community_lands_port: 'advanced',
        port: 'advanced'
      };
      for (var key in settings) {
        var html = sections[section_keys[key] || 'general'];
        var item_id = "settings-form-" + key;
        html += '<div class="form-group">'
        html += '<label for="'+item_id+'">' + t('prompt.settings.' + key) + '</label>';
        if (key == 'locale') {
          var options = [ { name: t('language.en'), value: 'en' }, { name: t('language.es'), value: 'es' }];
          html += '<select id="'+item_id+'" class="form-control key-value" data-key="' + key + '">';
          for (var k = 0; k < options.length; k++) {
            var opt = options[k];
            html += '<option value="' + opt.value + '"'
            if (opt.value == settings[key])
              html += ' selected';
            html += '>' + opt.name + '</option>';
          }
          html += "</select>";
        } else if (key == 'data_directory') {
          html += '<div class="row">';
          html += '<div class="col-xs-4">';
          html += '<button onclick="javascript:chooseDataDirectory();" class="form-control btn btn-small btn-default">' + t('button.choose') + '</button>';
          html += '</div><div class="col-xs-8">';
          html += '<input id="'+item_id+'" type="text" data-key="' + key + '" class="form-control key-value" value="' + settings[key] + '" />';
          html += '</div></div>';
        } else if (key == 'mapZoom') {
          html += '<input id="'+item_id+'" type="number" data-key="' + key + '" class="form-control key-value" ';
          if (settings[key])
            html += 'value="' + settings[key] + '"';
          html += ' min="1" max="18" />';
        } else {
          html += '<input id="'+item_id+'" type="text" data-key="' + key + '" class="form-control key-value" ';
          if (settings[key])
            html += 'value="' + settings[key] + '"';
          html += ' />';
        }
        if (t_exists('help.settings.'+key))
          html += '<span class="help-block">' + t('help.settings.'+key) + '</span>';
        html += '</div>';
        sections[section_keys[key] || 'general'] = html;
      }
      var html = '<form>';
      for (var key in sections) {
        if (sections[key] != '') {
          html += '<h6 class="text-uppercase" style="letter-spacing: 1px; font-weight: 700; color: #959595">';
          html += t("subtitle.settings."  + key);
          html += '</h6>';
          html += sections[key];
        }
      }
      html += "</form>";
      document.getElementById('settings_form').innerHTML = html;
    });
    ipc.on('has_configuration', function(configuration) {
      config = configuration;
      document.getElementById('baseUrl').innerHTML = configuration.baseUrl
      document.getElementById('shared_secret').innerHTML = configuration.shared_secret
      document.getElementById('mapUrl').innerHTML = '<a id="mapUrlLink" href="' + configuration.baseUrl + '/mapfilter?locale=' + 
        configuration.locale + '">' + configuration.baseUrl + '/mapfilter</a>'; 
      document.getElementById('form_folder').innerHTML = configuration.directory + "/Monitoring/" + configuration.station + "/Forms"
      if (configuration.community_lands == true)
        document.getElementById('community_lands_content').className = "";
      document.getElementById('mapUrlLink').onclick = function(evt) {
        evt.preventDefault();
        shell.openExternal(this.getAttribute('href'));
      };
    });
    ipc.on('has_select_data_directory', function(folder) {
      document.getElementById('settings-form-data_directory').value = folder;
    });
    ipc.on('has_settings_save', function(result) {
      var json = JSON.parse(result);
      if (json.error)
        alert(t('error.'+json.code));
      else
        alert(t('message.settings_saved'));
    });
    ipc.send('show_configuration');
    ipc.send('check_last_backup');
    ipc.send('form_list');
    ipc.send('filter_list');
    ipc.send('settings_list');

    window.addEventListener('online',  updateOnlineStatus);
    window.addEventListener('offline',  updateOnlineStatus);

    updateOnlineStatus();

    function communityLandsUpload() {
      if (navigator.onLine) {
        document.getElementById('community_lands_sync_status').innerHTML = t('progress.uploading');
        ipc.send('community_lands_backup');
      } else {
        alert(t('alert.no_internet'));
      }
    }

    function backupFiles() {
      document.getElementById('backup_status').innerHTML = t('progress.saving');
      ipc.send('backup_submissions');
    }

    function openBackupFile() {
      var file = document.getElementById('backup_file').getAttribute('data-location');
      shell.showItemInFolder(file);
    }

    function openBackupFolder() {
      if (config)
        shell.showItemInFolder(config.directory + "/Monitoring/" + config.station + "/Backup");
    }

    function selectForm() {
      ipc.send('select_form');
    }

    function translatePage() {
      var tags = ['h4', 'h5', 'div', 'span', 'b', 'button'];
      for (var i = 0; i < tags.length; i++) {
        var els = document.getElementsByTagName(tags[i]);
        for (var k = 0; k < els.length; k++) {
          if (els[k].getAttribute("data-translate"))
            els[k].innerHTML = window.t(els[k].getAttribute("data-translate"));
        }
      }
    }

    function chooseDataDirectory() {
      ipc.send('select_data_directory');
    }

    function saveSettings() {
      var els = document.getElementsByClassName('key-value');
      var object = {};
      for (var i = 0; i < els.length; i++) {
        var el = els[i];
        var key = el.getAttribute('data-key');
        object[key] = el.value;
      }
      ipc.send('settings_save', object);
    }

    </script>
    <script type="text/javascript">
      document.onreadystatechange = function () {
        if (document.readyState == "complete") {
          translatePage();
        }
      }
    </script>
  </head>
  <body><div class="container-fluid"><div class="row"><div class="col-xs-12">
    <div class="alert alert-info" style='margin-top: 10px'>
      <b data-translate="alert.running">The monitoring station will run as long as this window is open.</b>
    </div>
    <h4 data-translate="title.odk_collect">ODK Collect settings</h4>
    <div class="well">
      <div data-translate="prompt.baseurl">
        Base URL:
      </div>
      <div><b id="baseUrl"></b></div>
      <div style='margin-top: 5px' data-translate="prompt.username">
        Use your agent number as the username.
      </div>
      <div style='margin-top: 5px' data-translate="prompt.password">
        Password:
      </div>
      <div><b id="shared_secret"></b></div>
    </div>
    <h4 data-translate="title.browser_settings">Browser settings</h4>
    <div class="well">
      <div data-translate="prompt.map_url">
        URL for viewing maps in your browser:
      </div>
      <div><b id="mapUrl"></b></div>
      <div id="saved-filters">
      </div>
    </div>
    <h4 data-translate="title.monitoring_forms">Monitoring Forms</h4>
    <div class="well">
      <div data-translate="prompt.monitoring_forms_folder">
        Folder for blank monitoring forms:
      </div>
      <div><b id="form_folder"></b></div>
      <div id="form_listing">
      </div>
      <h5 data-translate="title.new_form">Add New Form</h5>
      <button onclick="javascript:selectForm();" class="btn btn-small btn-primary" data-translate="button.select_file">Select from File</button>
    </div>
    <h4 data-translate="title.data_backup">Data Backup</h4>
    <div class="well">
      <div id="last_backup"></div>
      <div data-translate="button.backup_data"class="btn btn-small btn-primary" style="margin-top: 10px" onclick="javascript:backupFiles()">Backup Data</div>
      <div style="margin-top: 10px" id="backup_status"></div>
    </div>
    <div class="hidden" id="community_lands_content">
      <h4 data-translate="title.community_lands">Community Lands</h4>
      <div class="well">
        <div>
          <span data-translate="prompt.connection_status">Connection Status: </span>
          <span id="connection_status" style="font-weight: bold">Pending</span>
        </div>
        <div>
          <span data-translate="prompt.last_synchronized">Last Synchronized: </span>
          <span id="community_lands_sync_date" style="font-weight: bold">Unavailable</span>
        </div>
        <div data-translate="button.upload" class="btn btn-small btn-primary" style="margin-top: 10px" onclick="javascript:communityLandsUpload()">Upload</div>
        <div style="margin-top: 10px" id="community_lands_sync_status"></div>
      </div>
    </div>
    <h4 data-translate="title.settings">Settings</h4>
    <div class="well">
      <div id="settings_form">

      </div>
      <button onclick="javascript:saveSettings();" class="btn btn-small btn-primary" data-translate="button.update_settings">Update Settings</button>
      <div id="settings_status"></div>
    </div>
    </div>
  </div></div></div></body>
</html>
